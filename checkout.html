<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Checkout | Science Based Body</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,400&family=Sora:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=20260211" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5NLZQKVWBW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5NLZQKVWBW');
    </script>
  </head>
  <body class="page-checkout">
    <header class="site-header">
      <div class="container header-grid">
        <a class="logo" href="index.html">
          <img src="/logo.png" alt="Science Based Body" />
        </a>
        <div class="site-search" id="site-search">
          <input type="text" class="site-search-input" id="search-input" placeholder="Search peptides..." autocomplete="off" aria-label="Search products" />
          <button type="button" class="site-search-btn" aria-label="Search">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          </button>
          <div class="search-results" id="search-results"></div>
        </div>
        <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">
          <span class="menu-icon"></span>
        </button>
        <button type="button" class="mobile-search-toggle" id="mobile-search-toggle" aria-label="Search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        </button>
        <nav class="site-nav">
          <a href="index.html" class="nav-link">Home</a>
          <a href="shop.html" class="nav-link">Shop</a>
          <a href="product.html" class="nav-link">Peptide Library</a>
          <button type="button" class="cart-toggle" data-cart-toggle aria-label="Open cart">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 6h15l-1.5 9h-12z"/>
              <circle cx="9" cy="20" r="1"/>
              <circle cx="18" cy="20" r="1"/>
              <path d="M6 6L5 3H2"/>
            </svg>
            <span class="cart-badge is-hidden">0</span>
          </button>
        </nav>
      </div>
    </header>

    <main>
      <section class="section checkout-section">
        <div class="container">
          <div class="checkout-header">
            <span class="label">CHECKOUT</span>
            <h1>Complete Your Order</h1>
          </div>

          <!-- 3-Step Process -->
          <div class="checkout-steps">
            <div class="checkout-step">
              <div class="checkout-step-number">1</div>
              <div class="checkout-step-content">
                <strong>Place Your Order</strong>
                <p>Fill in shipping details, select payment method, and submit your order.</p>
              </div>
            </div>
            <div class="checkout-step-divider"></div>
            <div class="checkout-step">
              <div class="checkout-step-number">2</div>
              <div class="checkout-step-content">
                <strong>Send Payment</strong>
                <p>You'll receive an email with payment instructions. Send via Zelle or Venmo.</p>
              </div>
            </div>
            <div class="checkout-step-divider"></div>
            <div class="checkout-step">
              <div class="checkout-step-number">3</div>
              <div class="checkout-step-content">
                <strong>Track Your Shipment</strong>
                <p>Once payment is confirmed, we ship your order and email you tracking info.</p>
              </div>
            </div>
          </div>

          <div class="checkout-grid">
            <!-- Order Summary -->
            <div class="checkout-summary">
              <div class="card">
                <h2>Order Summary</h2>
                <div id="checkout-items" class="checkout-items">
                  <!-- Populated by JavaScript -->
                </div>
                <div class="checkout-totals">
                  <div class="checkout-row">
                    <span>Subtotal</span>
                    <span id="checkout-subtotal">$0.00</span>
                  </div>
                  <div class="checkout-row">
                    <span>Shipping</span>
                    <span id="checkout-shipping">Calculated at next step</span>
                  </div>
                  <div class="checkout-row">
                    <span>Tax</span>
                    <span id="checkout-tax">$0.00</span>
                  </div>
                  <div class="checkout-row checkout-total">
                    <span>Total</span>
                    <span id="checkout-total">$0.00</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Checkout Form -->
            <div class="checkout-form-container">
              <!-- Login/Register prompt for guests -->
              <div id="checkout-auth-banner" class="card checkout-step" style="display:none;text-align:center;padding:20px 28px;">
                <p style="margin:0 0 12px 0;font-size:0.95rem;color:var(--ink);">
                  Already have an account? <a href="login.html?redirect=checkout" style="color:var(--rose);font-weight:600;">Sign in</a> for faster checkout.
                </p>
                <p style="margin:0;font-size:0.85rem;color:#6b7280;">
                  Or continue as a guest &mdash; we'll create an account for you automatically.
                </p>
              </div>

              <form id="checkout-form" class="checkout-form">
                <!-- Contact Information -->
                <div class="card checkout-step">
                  <h2>1. Contact Information</h2>
                  <div class="form-grid">
                    <div class="form-group">
                      <label for="email">Email Address *</label>
                      <input type="email" id="email" name="email" required placeholder="your@email.com"
                        pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}" />
                      <span class="field-error" id="email-error"></span>
                    </div>
                    <div class="form-group">
                      <label for="phone">Phone Number *</label>
                      <input type="tel" id="phone" name="phone" required placeholder="(555) 123-4567"
                        pattern="[\d\s\(\)\-\+]{7,}" />
                      <span class="field-error" id="phone-error"></span>
                    </div>
                  </div>
                </div>

                <!-- Shipping Address -->
                <div class="card checkout-step">
                  <h2>2. Shipping Address</h2>
                  <div class="form-grid">
                    <div class="form-group">
                      <label for="firstName">First Name *</label>
                      <input type="text" id="firstName" name="firstName" required minlength="2" />
                      <span class="field-error" id="firstName-error"></span>
                    </div>
                    <div class="form-group">
                      <label for="lastName">Last Name *</label>
                      <input type="text" id="lastName" name="lastName" required minlength="2" />
                      <span class="field-error" id="lastName-error"></span>
                    </div>
                    <div class="form-group form-group-full">
                      <label for="company">Company / Institution (Optional)</label>
                      <input type="text" id="company" name="company" placeholder="Research lab, university, etc." />
                    </div>
                    <div class="form-group form-group-full">
                      <label for="address1">Street Address *</label>
                      <input type="text" id="address1" name="address1" required minlength="3" />
                      <span class="field-error" id="address1-error"></span>
                    </div>
                    <div class="form-group form-group-full">
                      <label for="address2">Apt, Suite, Unit (Optional)</label>
                      <input type="text" id="address2" name="address2" />
                    </div>
                    <div class="form-group">
                      <label for="city">City *</label>
                      <input type="text" id="city" name="city" required minlength="2" />
                      <span class="field-error" id="city-error"></span>
                    </div>
                    <div class="form-group">
                      <label for="state">State / Province *</label>
                      <input type="text" id="state" name="state" required maxlength="2" minlength="2" placeholder="AZ"
                        pattern="[A-Za-z]{2}" style="text-transform: uppercase;" />
                      <span class="field-error" id="state-error"></span>
                    </div>
                    <div class="form-group">
                      <label for="zip">ZIP / Postal Code *</label>
                      <input type="text" id="zip" name="zip" required placeholder="85234"
                        pattern="\d{5}(-\d{4})?|[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d" />
                      <span class="field-error" id="zip-error"></span>
                    </div>
                    <div class="form-group">
                      <label for="country">Country *</label>
                      <select id="country" name="country" required>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Shipping Method -->
                <div class="card checkout-step">
                  <h2>3. Shipping Method</h2>
                  <div class="shipping-methods">
                    <label class="payment-option">
                      <input type="radio" name="shippingMethod" value="standard" checked />
                      <span class="payment-label">
                        <strong>Standard Shipping</strong>
                        <span id="standard-shipping-label">$25.00 (Free over $500)</span>
                      </span>
                    </label>
                    <label class="payment-option">
                      <input type="radio" name="shippingMethod" value="expedited" />
                      <span class="payment-label">
                        <strong>Expedited Shipping</strong>
                        <span>$50.00</span>
                      </span>
                    </label>
                  </div>
                </div>

                <!-- Payment Method -->
                <div class="card checkout-step">
                  <h2>4. Payment Method</h2>
                  <p class="checkout-note">Select your preferred payment method. Payment details will be included in your order confirmation email.</p>
                  <div class="payment-methods">
                    <label class="payment-option">
                      <input type="radio" name="paymentMethod" value="zelle" checked />
                      <span class="payment-label">
                        <strong>Zelle</strong>
                      </span>
                    </label>
                    <label class="payment-option">
                      <input type="radio" name="paymentMethod" value="venmo" />
                      <span class="payment-label">
                        <strong>Venmo</strong>
                      </span>
                    </label>
                  </div>
                </div>

                <!-- Discount Code (Optional) -->
                <div class="card checkout-step">
                  <h2>5. Discount Code</h2>
                  <div style="display:flex;gap:8px;align-items:flex-end;">
                    <input type="text" id="discount-code" name="discountCode" placeholder="Enter code (e.g. WELCOME10)" style="flex:1;text-transform:uppercase;" autocomplete="off" />
                    <button type="button" id="apply-discount" class="btn btn-primary" style="white-space:nowrap;padding:10px 20px;">Apply</button>
                  </div>
                  <p id="discount-feedback" style="font-size:0.85rem;margin-top:6px;"></p>
                </div>

                <!-- Compliance Acknowledgments (REQUIRED) -->
                <div class="card checkout-step compliance-section">
                  <h2>6. Research Use Acknowledgment</h2>
                  <p class="compliance-intro">
                    <strong>Important:</strong> All products are sold for research and educational purposes only.
                    You must acknowledge and agree to the following statements to complete your order.
                  </p>

                  <div class="compliance-checkboxes">
                    <!-- Master "Agree to All" checkbox -->
                    <label class="compliance-checkbox compliance-master">
                      <input type="checkbox" id="compliance-all" />
                      <span class="checkbox-mark"></span>
                      <span class="checkbox-text"><strong>I acknowledge and agree to all of the following statements</strong></span>
                    </label>

                    <label class="compliance-checkbox">
                      <input type="checkbox" id="compliance1" name="researchPurposeOnly" required />
                      <span class="checkbox-mark"></span>
                      <span class="checkbox-text">I confirm all products are for <strong>research purposes only</strong> and will not be used for human or animal consumption.</span>
                    </label>

                    <label class="compliance-checkbox">
                      <input type="checkbox" id="compliance2" name="ageConfirmation" required />
                      <span class="checkbox-mark"></span>
                      <span class="checkbox-text">I confirm I am <strong>18 years of age or older</strong>.</span>
                    </label>

                    <label class="compliance-checkbox">
                      <input type="checkbox" id="compliance3" name="noHumanConsumption" required />
                      <span class="checkbox-mark"></span>
                      <span class="checkbox-text">I understand these products are <strong>not for human consumption</strong>, not FDA approved, and not intended to diagnose, treat, cure, or prevent any disease.</span>
                    </label>

                    <label class="compliance-checkbox">
                      <input type="checkbox" id="compliance4" name="responsibilityAccepted" required />
                      <span class="checkbox-mark"></span>
                      <span class="checkbox-text">I accept <strong>full responsibility</strong> for proper handling, storage, and lawful use of these research materials.</span>
                    </label>

                    <label class="compliance-checkbox">
                      <input type="checkbox" id="compliance5" name="termsAccepted" required />
                      <span class="checkbox-mark"></span>
                      <span class="checkbox-text">I have read and agree to the <a href="terms.html" target="_blank">Terms of Service</a> and <a href="privacy.html" target="_blank">Privacy Policy</a>.</span>
                    </label>
                  </div>

                  <p class="compliance-warning" id="compliance-warning" style="display: none;">
                    Please acknowledge all research use statements to continue.
                  </p>
                </div>

                <!-- Error Banner -->
                <div id="checkout-error" style="display:none;background:rgba(220,50,50,0.15);border:1.8pt solid rgba(220,50,50,0.4);color:#ff6b6b;padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:0.9rem;"></div>

                <!-- Submit -->
                <div class="checkout-submit">
                  <button type="submit" class="btn btn-primary btn-large" id="submit-order">
                    Place Order & Request Payment Link
                  </button>
                  <p class="checkout-secure">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                      <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                    Your information is secure and encrypted.
                  </p>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <!-- Special Order Warning Modal -->
      <div class="modal" id="special-order-modal" aria-hidden="true">
        <div class="modal-overlay"></div>
        <div class="modal-card">
          <div class="modal-body" style="text-align:center;">
            <div style="margin-bottom:12px;">
              <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#e3a7a1" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
            </div>
            <h2 style="margin-bottom:8px;">Special Order Notice</h2>
            <p style="margin-bottom:12px;">Your cart contains <strong>special-order item(s)</strong> that are not currently in stock:</p>
            <ul id="special-order-list" style="text-align:left;margin:0 auto 16px;max-width:360px;list-style:none;padding:0;"></ul>
            <p style="margin-bottom:20px;color:var(--rose,#e3a7a1);font-weight:600;">These items will be ordered from our supplier and may take additional time to ship.</p>
            <button type="button" class="btn btn-primary" id="special-order-ok" style="margin-right:10px;">OK, Continue to Checkout</button>
            <a href="shop.html" class="btn" style="background:transparent;border:1px solid var(--glass-border,rgba(255,255,255,0.2));color:var(--ink,#1f2a36);">Back to Shop</a>
          </div>
        </div>
      </div>

      <!-- Order Confirmation Modal -->
      <div class="modal" id="order-confirmation-modal" aria-hidden="true">
        <div class="modal-overlay" data-modal-close></div>
        <div class="modal-card">
          <button type="button" class="modal-close" data-modal-close>&times;</button>
          <div class="modal-body">
            <div class="confirmation-icon">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9 12l2 2 4-4"/>
              </svg>
            </div>
            <h2>Order Received!</h2>
            <p class="confirmation-order-number">Order #<span id="confirmation-order-id">SBB-XXXXX</span></p>
            <p style="font-size:1.3rem;font-weight:700;margin:8px 0;">Total: <span id="confirmation-total">$0.00</span></p>
            <p>Thank you for your order. A payment link has been sent to your email address.</p>
            <div id="payment-instructions" style="display:none;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:16px;margin:16px 0;text-align:left;">
              <p style="margin-bottom:8px;"><strong>Payment Instructions:</strong></p>
              <p id="payment-instructions-text" style="white-space:pre-line;"></p>
            </div>
            <div class="confirmation-details">
              <p><strong>What happens next:</strong></p>
              <ol>
                <li>Complete payment using the instructions above</li>
                <li>We'll verify and process your order</li>
                <li>You'll receive tracking info once shipped</li>
              </ol>
            </div>
            <a href="index.html" class="btn btn-primary">Return to Homepage</a>
          </div>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container footer-grid">
        <div>
          <div class="footer-brand">
            <a class="footer-logo" href="index.html">
              <img src="/logo.png" alt="Science Based Body" />
            </a>
            <span class="label">SCIENCE BASED BODY</span>
          </div>
          <p>Research peptide supply with transparent batch standards.</p>
        </div>
        <div class="footer-links">
          <a href="terms.html" class="text-link">Terms</a>
          <a href="privacy.html" class="text-link">Privacy</a>
          <a href="shipping.html" class="text-link">Shipping</a>
          <a href="returns.html" class="text-link">Returns</a>
          <a href="research-use.html" class="text-link">Research Use Only</a>
        </div>
      </div>
    </footer>

    <!-- Cart Overlay -->
    <div class="cart-overlay" id="cart-overlay"></div>

    <!-- Cart Drawer -->
    <aside class="cart-drawer" id="cart-drawer" aria-hidden="true">
      <div class="cart-drawer-header">
        <h2>Your Cart</h2>
        <button type="button" class="cart-drawer-close" data-cart-close aria-label="Close cart">&times;</button>
      </div>
      <div class="cart-drawer-body">
        <p id="cart-empty" class="cart-empty">Your cart is empty.</p>
        <div id="cart-items"></div>
      </div>
      <div class="cart-drawer-footer">
        <div class="cart-subtotal">
          <span>Subtotal</span>
          <span id="cart-subtotal">$0.00</span>
        </div>
        <a href="checkout.html" class="btn btn-primary cart-checkout-btn is-hidden" id="cart-checkout-btn">Proceed to Checkout</a>
      </div>
    </aside>

    <script src="scripts.js?v=20260211"></script>
    <script>
      // Checkout — wired to backend API
      document.addEventListener('DOMContentLoaded', () => {
        window.scrollTo(0, 0);
        const API_BASE = window.location.hostname === 'localhost'
          ? 'http://localhost:3001/api/v1'
          : 'https://api.sbbpeptides.com/api/v1';

        const checkoutItems  = document.getElementById('checkout-items');
        const checkoutSubtotal = document.getElementById('checkout-subtotal');
        const checkoutShipping = document.getElementById('checkout-shipping');
        const checkoutTax    = document.getElementById('checkout-tax');
        const checkoutTotal  = document.getElementById('checkout-total');
        const checkoutForm   = document.getElementById('checkout-form');
        const complianceWarning = document.getElementById('compliance-warning');
        const confirmationModal = document.getElementById('order-confirmation-modal');
        const checkoutError  = document.getElementById('checkout-error');
        const submitBtn      = document.getElementById('submit-order');

        let resolvedItems = [];
        let subtotal = 0;
        let taxAmount = 0;
        let appliedDiscount = null;

        /* ── Auth header helper ── */
        function authHeaders() {
          var h = { 'Content-Type': 'application/json' };
          var token = localStorage.getItem('accessToken');
          if (token) h['Authorization'] = 'Bearer ' + token;
          return h;
        }

        /* ── Pre-fill from logged-in user or show auth banner ── */
        try {
          var savedUser = JSON.parse(localStorage.getItem('sbb_user'));
          if (savedUser && localStorage.getItem('accessToken')) {
            if (savedUser.email) document.getElementById('email').value = savedUser.email;
            if (savedUser.phone) document.getElementById('phone').value = savedUser.phone;
            if (savedUser.firstName) document.getElementById('firstName').value = savedUser.firstName;
            if (savedUser.lastName) document.getElementById('lastName').value = savedUser.lastName;
          } else {
            var authBanner = document.getElementById('checkout-auth-banner');
            if (authBanner) authBanner.style.display = 'block';
          }
        } catch (e) {
          var authBanner = document.getElementById('checkout-auth-banner');
          if (authBanner) authBanner.style.display = 'block';
        }

        /* ── Master compliance "Agree to All" toggle ── */
        const masterCheckbox = document.getElementById('compliance-all');
        const individualBoxes = document.querySelectorAll('.compliance-checkbox:not(.compliance-master) input[type="checkbox"]');

        if (masterCheckbox) {
          masterCheckbox.addEventListener('change', function () {
            individualBoxes.forEach(function (cb) { cb.checked = masterCheckbox.checked; });
          });
          individualBoxes.forEach(function (cb) {
            cb.addEventListener('change', function () {
              masterCheckbox.checked = Array.from(individualBoxes).every(function (c) { return c.checked; });
            });
          });
        }

        /* ── Field validation ────────────────────────────── */
        const validators = {
          email: {
            test: v => /^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/.test(v),
            msg: 'Please enter a valid email address'
          },
          phone: {
            test: v => /[\d]{7,}/.test(v.replace(/\D/g, '')),
            msg: 'Please enter a valid phone number (at least 7 digits)'
          },
          firstName: {
            test: v => v.trim().length >= 2,
            msg: 'First name must be at least 2 characters'
          },
          lastName: {
            test: v => v.trim().length >= 2,
            msg: 'Last name must be at least 2 characters'
          },
          address1: {
            test: v => v.trim().length >= 3,
            msg: 'Please enter a valid street address'
          },
          city: {
            test: v => v.trim().length >= 2,
            msg: 'Please enter a valid city'
          },
          state: {
            test: v => /^[A-Za-z]{2}$/.test(v.trim()),
            msg: 'Enter a 2-letter state code (e.g. AZ, CA)'
          },
          zip: {
            test: v => /^\d{5}(-\d{4})?$/.test(v.trim()) || /^[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d$/.test(v.trim()),
            msg: 'Enter a valid ZIP (e.g. 85234) or postal code'
          }
        };

        function showFieldError(fieldId, msg) {
          var el = document.getElementById(fieldId);
          var errEl = document.getElementById(fieldId + '-error');
          if (el) el.classList.add('field-invalid');
          if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
        }

        function clearFieldError(fieldId) {
          var el = document.getElementById(fieldId);
          var errEl = document.getElementById(fieldId + '-error');
          if (el) el.classList.remove('field-invalid');
          if (errEl) { errEl.textContent = ''; errEl.style.display = 'none'; }
        }

        function validateField(fieldId) {
          var el = document.getElementById(fieldId);
          if (!el) return true;
          var v = el.value;
          var rule = validators[fieldId];
          if (!rule) return true;
          if (!v && el.required) { showFieldError(fieldId, 'This field is required'); return false; }
          if (v && !rule.test(v)) { showFieldError(fieldId, rule.msg); return false; }
          clearFieldError(fieldId);
          return true;
        }

        function validateAllFields() {
          var valid = true;
          Object.keys(validators).forEach(function (fieldId) {
            if (!validateField(fieldId)) valid = false;
          });
          return valid;
        }

        // Live validation on blur
        Object.keys(validators).forEach(function (fieldId) {
          var el = document.getElementById(fieldId);
          if (el) {
            el.addEventListener('blur', function () { validateField(fieldId); });
            el.addEventListener('input', function () {
              if (el.classList.contains('field-invalid')) validateField(fieldId);
            });
          }
        });

        // Phone auto-format: (555) 123-4567
        var phoneInput = document.getElementById('phone');
        if (phoneInput) {
          phoneInput.addEventListener('input', function () {
            var digits = this.value.replace(/\D/g, '').substring(0, 10);
            if (digits.length === 0) { this.value = ''; return; }
            if (digits.length <= 3) { this.value = '(' + digits; }
            else if (digits.length <= 6) { this.value = '(' + digits.slice(0, 3) + ') ' + digits.slice(3); }
            else { this.value = '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6); }
          });
        }

        // State uppercase
        var stateInput = document.getElementById('state');
        if (stateInput) {
          stateInput.addEventListener('input', function () {
            this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '').substring(0, 2);
          });
        }

        /* ── Shipping cost ─────────────────────────────── */
        const FREE_SHIPPING_THRESHOLD = 500;
        const STANDARD_SHIPPING = 25;
        const EXPEDITED_SHIPPING = 50;

        const getShippingCost = () => {
          const method = document.querySelector('input[name="shippingMethod"]:checked');
          if (method && method.value === 'expedited') return EXPEDITED_SHIPPING;
          return subtotal >= FREE_SHIPPING_THRESHOLD ? 0 : STANDARD_SHIPPING;
        };

        const updateTotals = () => {
          const shipping = getShippingCost();
          checkoutSubtotal.textContent = '$' + subtotal.toFixed(2);
          checkoutShipping.textContent = shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2);
          checkoutTax.textContent      = taxAmount > 0 ? '$' + taxAmount.toFixed(2) : '$0.00';
          checkoutTotal.textContent    = '$' + (subtotal + shipping + taxAmount).toFixed(2);

          var stdLabel = document.getElementById('standard-shipping-label');
          if (stdLabel) {
            stdLabel.textContent = subtotal >= FREE_SHIPPING_THRESHOLD
              ? 'FREE (order over $500)'
              : '$' + STANDARD_SHIPPING.toFixed(2) + ' (Free over $500)';
          }
        };

        document.querySelectorAll('input[name="shippingMethod"]').forEach(function (r) {
          r.addEventListener('change', updateTotals);
        });

        /* ── Error helper ──────────────────────────────── */
        const showError = (msg) => {
          checkoutError.textContent = msg;
          checkoutError.style.display = 'block';
          checkoutError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => { checkoutError.style.display = 'none'; }, 12000);
        };

        /* ── Tax calculation (TaxJar via API) ─────────── */
        let taxTimer = null;
        const calculateTax = async () => {
          if (resolvedItems.length === 0 || subtotal === 0) { taxAmount = 0; updateTotals(); return; }
          var state = document.getElementById('state').value;
          var zip   = document.getElementById('zip').value;
          var city  = document.getElementById('city').value;
          var country = document.getElementById('country').value;
          if (!state || !zip || !city) return;

          try {
            var res = await fetch(API_BASE + '/tax/calculate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                toState: state, toZip: zip, toCity: city, toCountry: country,
                shipping: getShippingCost(),
                lineItems: resolvedItems.map(function (item) {
                  return { productId: item.productId, quantity: item.quantity, unitPrice: item.unitPrice };
                })
              })
            });
            if (res.ok) {
              var data = await res.json();
              taxAmount = data.taxAmount || 0;
            } else {
              taxAmount = 0;
            }
          } catch (e) {
            taxAmount = 0;
          }
          updateTotals();
        };

        // Debounce tax calc when address changes
        ['state', 'zip', 'city', 'country'].forEach(function (id) {
          var el = document.getElementById(id);
          if (el) el.addEventListener('change', function () {
            clearTimeout(taxTimer);
            taxTimer = setTimeout(calculateTax, 600);
          });
        });

        /* ── Resolve cart against API ──────────────────── */
        const loadCheckoutItems = async () => {
          const cart = JSON.parse(localStorage.getItem('sbb_cart') || '[]');

          if (cart.length === 0) {
            checkoutItems.innerHTML = '<p class="empty-cart-msg">Your cart is empty. <a href="shop.html">Continue shopping</a></p>';
            submitBtn.disabled = true;
            return;
          }

          checkoutItems.innerHTML = '<p>Validating cart items…</p>';

          try {
            const res = await fetch(API_BASE + '/checkout/resolve-cart', {
              method: 'POST',
              headers: authHeaders(),
              body: JSON.stringify({
                items: cart.map(item => ({
                  cartId: item.id,
                  name: item.name,
                  variant: item.variant || null,
                  quantity: item.quantity
                }))
              })
            });

            if (!res.ok) throw new Error('Failed to validate cart items');

            const data = await res.json();
            resolvedItems = data.resolvedItems || [];

            if (data.unresolvedItems && data.unresolvedItems.length > 0) {
              var names = data.unresolvedItems.map(function (u) { return u.name; }).join(', ');
              showError('Some items could not be found: ' + names);
            }

            if (resolvedItems.length === 0) {
              checkoutItems.innerHTML = '<p class="empty-cart-msg">No valid items in cart. <a href="shop.html">Continue shopping</a></p>';
              submitBtn.disabled = true;
              return;
            }

            subtotal = resolvedItems.reduce(function (sum, item) { return sum + item.unitPrice * item.quantity; }, 0);

            checkoutItems.innerHTML = resolvedItems.map(function (item) {
              return '<div class="checkout-item">' +
                '<img src="/images/products/vial.png" alt="' + item.productName + '" />' +
                '<div class="checkout-item-details">' +
                  '<h4>' + item.productName + '</h4>' +
                  (item.variantName ? '<span class="variant">' + item.variantName + '</span>' : '') +
                  '<span class="qty">Qty: ' + item.quantity + '</span>' +
                '</div>' +
                '<span class="checkout-item-price">$' + (item.unitPrice * item.quantity).toFixed(2) + '</span>' +
              '</div>';
            }).join('');

            updateTotals();
          } catch (err) {
            // Fallback: render from localStorage prices
            console.error('Cart resolution failed:', err);
            subtotal = cart.reduce(function (sum, item) { return sum + (item.price * item.quantity); }, 0);
            checkoutItems.innerHTML = cart.map(function (item) {
              return '<div class="checkout-item">' +
                '<img src="' + (item.image || '/images/products/vial.png') + '" alt="' + item.name + '" />' +
                '<div class="checkout-item-details">' +
                  '<h4>' + item.name + '</h4>' +
                  (item.variant ? '<span class="variant">' + item.variant + '</span>' : '') +
                  '<span class="qty">Qty: ' + item.quantity + '</span>' +
                '</div>' +
                '<span class="checkout-item-price">$' + (item.price * item.quantity).toFixed(2) + '</span>' +
              '</div>';
            }).join('');
            updateTotals();
            showError('Could not verify items with server. Prices shown are from your cart.');
          }
        };

        loadCheckoutItems().then(function () {
          // Trigger initial tax calculation once items are resolved
          calculateTax();

          // Check for special-order items and show warning
          var specialItems = resolvedItems.filter(function (item) { return !item.inStock && item.leadTimeDays; });
          if (specialItems.length > 0) {
            var soModal = document.getElementById('special-order-modal');
            var soList = document.getElementById('special-order-list');
            soList.innerHTML = specialItems.map(function (item) {
              return '<li style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.08);">' +
                '<strong>' + item.productName + '</strong>' +
                (item.variantName ? ' — ' + item.variantName : '') +
                '</li>';
            }).join('');
            soModal.classList.add('is-open');
            soModal.setAttribute('aria-hidden', 'false');

            document.getElementById('special-order-ok').addEventListener('click', function () {
              soModal.classList.remove('is-open');
              soModal.setAttribute('aria-hidden', 'true');
            });
          }
        });

        /* ── Payment method mapping ────────────────────── */
        var PAYMENT_MAP = {
          zelle:   'ZELLE',
          venmo:   'VENMO'
        };

        /* ── Discount Code ─────────────────────────── */
        var discountBtn = document.getElementById('apply-discount');
        var discountInput = document.getElementById('discount-code');
        var discountFeedback = document.getElementById('discount-feedback');
        if (discountBtn) {
          discountBtn.addEventListener('click', async () => {
            var code = (discountInput.value || '').trim().toUpperCase();
            if (!code) { discountFeedback.textContent = 'Please enter a code.'; discountFeedback.style.color = '#92400e'; return; }
            discountFeedback.textContent = 'Checking…';
            discountFeedback.style.color = '#71717a';
            try {
              var r = await fetch(API_BASE + '/cart/validate-discount?code=' + encodeURIComponent(code) + '&subtotal=' + subtotal, { headers: authHeaders() });
              var d = await r.json();
              if (!r.ok) throw new Error(d.message || 'Invalid code');
              appliedDiscount = code;
              var desc = d.type === 'PERCENTAGE' ? (d.value + '% off') : ('$' + d.value.toFixed(2) + ' off');
              discountFeedback.innerHTML = '<strong>' + code + '</strong> applied — ' + desc;
              discountFeedback.style.color = '#166534';
              discountInput.disabled = true;
              discountBtn.disabled = true;
            } catch (err) {
              appliedDiscount = null;
              discountFeedback.textContent = err.message;
              discountFeedback.style.color = '#dc2626';
            }
          });
        }

        /* ── Form submit → API ─────────────────────────── */
        checkoutForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          checkoutError.style.display = 'none';

          // Validate all form fields
          if (!validateAllFields()) {
            var firstInvalid = document.querySelector('.field-invalid');
            if (firstInvalid) firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }

          // Validate compliance
          const complianceBoxes = checkoutForm.querySelectorAll('.compliance-checkbox input[type="checkbox"]');
          const allChecked = Array.from(complianceBoxes).every(cb => cb.checked);
          if (!allChecked) {
            complianceWarning.style.display = 'block';
            document.querySelector('.compliance-section').scrollIntoView({ behavior: 'smooth' });
            return;
          }
          complianceWarning.style.display = 'none';

          if (resolvedItems.length === 0) {
            showError('No valid items to order. Please add items to your cart.');
            return;
          }

          // Disable button while submitting
          submitBtn.disabled = true;
          submitBtn.textContent = 'Placing Order…';

          const fd = new FormData(checkoutForm);
          const payRaw = fd.get('paymentMethod');

          const payload = {
            items: resolvedItems.map(function (item) {
              var o = { productId: item.productId, quantity: item.quantity };
              if (item.variantId) o.variantId = item.variantId;
              return o;
            }),
            shippingAddress: {
              firstName:  fd.get('firstName'),
              lastName:   fd.get('lastName'),
              company:    fd.get('company') || undefined,
              street1:    fd.get('address1'),
              street2:    fd.get('address2') || undefined,
              city:       fd.get('city'),
              state:      fd.get('state'),
              postalCode: fd.get('zip'),
              country:    fd.get('country'),
              phone:      fd.get('phone') || undefined
            },
            sameAsShipping:  true,
            shippingMethod:  fd.get('shippingMethod') || 'standard',
            paymentMethod:   PAYMENT_MAP[payRaw] || 'ZELLE',
            compliance: {
              researchPurposeOnly:   !!fd.get('researchPurposeOnly'),
              ageConfirmation:       !!fd.get('ageConfirmation'),
              noHumanConsumption:    !!fd.get('noHumanConsumption'),
              responsibilityAccepted: !!fd.get('responsibilityAccepted'),
              termsAccepted:         !!fd.get('termsAccepted')
            },
            guestEmail: fd.get('email'),
            discountCode: appliedDiscount || undefined,
            taxAmount: taxAmount,
            affiliateReferralCode: (document.cookie.match(/sbb_ref=([^;]+)/) || [])[1] || undefined
          };

          try {
            const res = await fetch(API_BASE + '/checkout/create-order', {
              method: 'POST',
              headers: authHeaders(),
              body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (!res.ok) {
              var msg = data.message || (data.errors ? data.errors.join(', ') : 'Order submission failed');
              throw new Error(msg);
            }

            // Clear cart
            localStorage.setItem('sbb_cart', '[]');
            try {
              if (window.SBBCart && typeof window.SBBCart.updateBadge === 'function') {
                window.SBBCart.items = [];
                window.SBBCart.updateBadge();
              }
            } catch (e) { console.warn('Cart badge update skipped:', e); }

            // Populate confirmation modal
            var orderNumber = (data.order && data.order.orderNumber) || 'N/A';
            document.getElementById('confirmation-order-id').textContent = orderNumber;
            var orderTotal = (data.order && data.order.totalAmount) ? parseFloat(data.order.totalAmount).toFixed(2) : '0.00';
            document.getElementById('confirmation-total').textContent = '$' + orderTotal;

            // Payment instructions
            var instrEl   = document.getElementById('payment-instructions');
            var instrText = document.getElementById('payment-instructions-text');
            if (data.payment && data.payment.instructions) {
              var pi = data.payment.instructions;
              if (typeof pi === 'object') {
                instrText.textContent = pi.instructions || (pi.method + ': ' + JSON.stringify(pi));
              } else {
                instrText.textContent = pi;
              }
              instrEl.style.display = 'block';
            }

            confirmationModal.classList.add('is-open');
            confirmationModal.setAttribute('aria-hidden', 'false');
          } catch (err) {
            console.error('Order failed:', err);
            showError(err.message || 'Something went wrong. Please try again.');
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Place Order & Request Payment Link';
          }
        });

        /* ── Modal close ───────────────────────────────── */
        confirmationModal.querySelectorAll('[data-modal-close]').forEach(el => {
          el.addEventListener('click', () => {
            confirmationModal.classList.remove('is-open');
            confirmationModal.setAttribute('aria-hidden', 'true');
          });
        });
      });
    </script>
  </body>
</html>
