<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password | Science Based Body</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:opsz,wght@6..96,400&family=Sora:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=20260213" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5NLZQKVWBW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-5NLZQKVWBW');
    </script>
  </head>
  <body class="page-checkout">
    <header class="site-header">
      <div class="container header-grid">
        <a class="logo" href="index.html">
          <img src="/logo.png" alt="Science Based Body" />
        </a>
        <nav class="site-nav">
          <a href="index.html" class="nav-link">Home</a>
          <a href="shop.html" class="nav-link">Shop</a>
          <a href="login.html" class="nav-link">Account</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="section checkout-section">
        <div class="container" style="max-width:520px;">
          <div class="checkout-header">
            <span class="label">ACCOUNT</span>
            <h1 id="page-title">Reset Password</h1>
          </div>

          <!-- Error banner -->
          <div id="auth-error" class="auth-error" style="display:none;"></div>

          <!-- No token state -->
          <div id="no-token" style="display:none;">
            <div class="card auth-card" style="text-align:center;padding:40px 20px;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#e3a7a1" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>
              <h3 style="margin:16px 0 8px;">Invalid Reset Link</h3>
              <p style="color:#666;font-size:0.9rem;">This password reset link is invalid or has expired.</p>
              <p style="margin-top:20px;">
                <a href="login.html" class="btn btn-primary">Back to Sign In</a>
              </p>
            </div>
          </div>

          <!-- Reset form -->
          <div id="reset-form-container" class="card auth-card" style="display:none;">
            <p style="margin-bottom:16px;font-size:0.9rem;color:#666;">Enter your new password below.</p>
            <form id="reset-form">
              <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" name="password" required minlength="8"
                  placeholder="Min 8 chars, uppercase, lowercase, number" />
              </div>
              <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" name="confirmPassword" required minlength="8" />
              </div>
              <button type="submit" class="btn btn-primary btn-large auth-submit" id="reset-btn">Reset Password</button>
            </form>
          </div>

          <!-- Success state -->
          <div id="success-panel" style="display:none;">
            <div class="card auth-card" style="text-align:center;padding:40px 20px;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>
              <h3 style="margin:16px 0 8px;">Password Reset Successful</h3>
              <p style="color:#666;font-size:0.9rem;">Your password has been updated. You can now sign in with your new password.</p>
              <p style="margin-top:20px;">
                <a href="login.html" class="btn btn-primary">Sign In</a>
              </p>
            </div>
          </div>

        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-grid">
        <div>
          <div class="footer-brand">
            <a class="footer-logo" href="index.html">
              <img src="/logo.png" alt="Science Based Body" />
            </a>
            <span class="label">SCIENCE BASED BODY</span>
          </div>
          <p>Research peptide supply with transparent batch standards.</p>
        </div>
        <div class="footer-links">
          <a href="terms.html" class="text-link">Terms</a>
          <a href="privacy.html" class="text-link">Privacy</a>
          <a href="shipping.html" class="text-link">Shipping</a>
          <a href="returns.html" class="text-link">Returns</a>
          <a href="research-use.html" class="text-link">Research Use Only</a>
        </div>
      </div>
    </footer>

    <script src="scripts.js?v=20260213"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const API_BASE = window.location.hostname === 'localhost'
          ? 'http://localhost:3001/api/v1'
          : 'https://api.sbbpeptides.com/api/v1';

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        const noToken      = document.getElementById('no-token');
        const formContainer = document.getElementById('reset-form-container');
        const successPanel  = document.getElementById('success-panel');
        const authError     = document.getElementById('auth-error');

        if (!token) {
          noToken.style.display = '';
          return;
        }

        formContainer.style.display = '';

        const showError = (msg) => {
          authError.textContent = msg;
          authError.style.display = 'block';
          authError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => { authError.style.display = 'none'; }, 8000);
        };

        const setLoading = (btn, loading) => {
          btn.disabled = loading;
          btn.dataset.origText = btn.dataset.origText || btn.textContent;
          btn.textContent = loading ? 'Please wait\u2026' : btn.dataset.origText;
        };

        document.getElementById('reset-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = document.getElementById('reset-btn');
          setLoading(btn, true);
          authError.style.display = 'none';

          const password = document.getElementById('new-password').value;
          const confirm  = document.getElementById('confirm-password').value;

          if (password !== confirm) {
            showError('Passwords do not match.');
            setLoading(btn, false);
            return;
          }

          if (password.length < 8) {
            showError('Password must be at least 8 characters.');
            setLoading(btn, false);
            return;
          }

          try {
            const res = await fetch(API_BASE + '/auth/reset-password', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token: token, password: password })
            });

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.message || 'Password reset failed. The link may have expired.');
            }

            formContainer.style.display = 'none';
            successPanel.style.display = '';

          } catch (err) {
            showError(err.message || 'Something went wrong. Please try again.');
          } finally {
            setLoading(btn, false);
          }
        });
      });
    </script>
  </body>
</html>
