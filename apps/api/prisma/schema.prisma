// =============================================================================
// SCIENCE BASED BODY - DATABASE SCHEMA
// =============================================================================
// Prisma Schema for Peptide E-Commerce Platform
// Run: npx prisma generate && npx prisma db push
// =============================================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  CLIENT
  CLINIC
  DISTRIBUTOR
  AFFILIATE
  BRAND_PARTNER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  BANNED
}

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PAYMENT_RECEIVED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  EPICOR_PROPELLO
  WIRE_TRANSFER
  ZELLE
  VENMO
  CRYPTO
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum ProductCategory {
  RESEARCH_PEPTIDES
  ANALYTICAL_REFERENCE_MATERIALS
  LABORATORY_ADJUNCTS
  RESEARCH_COMBINATIONS
  MATERIALS_SUPPLIES
  MERCHANDISE
}

enum KycStatus {
  NOT_REQUIRED
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum ShipmentStatus {
  PENDING
  LABEL_CREATED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  EXCEPTION
  RETURNED
}

enum FileType {
  COA
  MSDS
  KYC_DOCUMENT
  PAYMENT_PROOF
  PRODUCT_IMAGE
  OTHER
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  VERIFY
  APPROVE
  REJECT
  SHIP
  REFUND
  PAYMENT_LINK_CREATED
  PAYMENT_LINK_RESENT
  PAYMENT_LINK_CANCELLED
  PAYMENT_LINK_MARKED_PAID
  AFFILIATE_APPLY
  AFFILIATE_APPROVE
  AFFILIATE_REJECT
  PARTNER_APPLY
  PARTNER_APPROVE
  PARTNER_REJECT
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LoyaltyPointType {
  EARNED
  REDEEMED
  BONUS
  EXPIRED
  ADJUSTED
}

// =============================================================================
// USER & AUTHENTICATION
// =============================================================================

model User {
  id                String      @id @default(cuid())
  email             String      @unique
  passwordHash      String
  firstName         String?
  lastName          String?
  phone             String?
  role              UserRole    @default(CLIENT)
  status            UserStatus  @default(ACTIVE)
  emailVerified     Boolean     @default(false)
  emailVerifiedAt   DateTime?
  lastLoginAt       DateTime?
  lastLoginIp       String?

  // Encrypted fields (PII)
  dateOfBirth       String?     // Encrypted
  governmentId      String?     // Encrypted

  // Admin notes (internal only)
  adminNotes      String?

  // Loyalty
  loyaltyPoints         Int       @default(0)
  lifetimeLoyaltyPoints Int       @default(0)

  // Relations
  addresses         Address[]
  orders            Order[]
  kycVerification   KycVerification?
  complianceAcks    ComplianceAcknowledgment[]
  auditLogs         AuditLog[]  @relation("UserAuditLogs")
  adminAuditLogs    AuditLog[]  @relation("AdminAuditLogs")
  stockNotifications StockNotification[]
  loyaltyTransactions LoyaltyTransaction[]
  paymentLinksCreated PaymentLink[] @relation("PaymentLinksCreated")

  // Affiliate
  affiliate         Affiliate?

  // Wholesale/B2B
  organizationId    String?
  organization      Organization? @relation(fields: [organizationId], references: [id])
  priceListId       String?
  priceList         PriceList?   @relation(fields: [priceListId], references: [id])

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([email])
  @@index([role])
  @@index([status])
}

model Address {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  label           String?   // "Home", "Office", etc.
  firstName       String
  lastName        String
  company         String?
  street1         String
  street2         String?
  city            String
  state           String
  postalCode      String
  country         String    @default("US")
  phone           String?

  isDefault       Boolean   @default(false)
  isBilling       Boolean   @default(false)
  isShipping      Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  orders          Order[]   @relation("ShippingAddress")
  billingOrders   Order[]   @relation("BillingAddress")

  @@index([userId])
}

// =============================================================================
// ORGANIZATION (B2B)
// =============================================================================

model Organization {
  id              String    @id @default(cuid())
  name            String
  type            String    // "CLINIC", "DISTRIBUTOR", "RESEARCH_LAB"
  taxId           String?
  licenseNumber   String?

  street1         String?
  street2         String?
  city            String?
  state           String?
  postalCode      String?
  country         String?

  users           User[]
  priceList       PriceList?

  isVerified      Boolean   @default(false)
  verifiedAt      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// =============================================================================
// KYC (Know Your Customer)
// =============================================================================

model KycVerification {
  id              String      @id @default(cuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  status          KycStatus   @default(PENDING)
  verificationType String     @default("STANDARD") // STANDARD, ENHANCED

  // Review info
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?

  // Expiration (annual re-verification)
  expiresAt       DateTime?

  documents       KycDocument[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([status])
}

model KycDocument {
  id              String          @id @default(cuid())
  kycId           String
  kyc             KycVerification @relation(fields: [kycId], references: [id], onDelete: Cascade)

  type            String          // GOVERNMENT_ID, PROOF_OF_ADDRESS, BUSINESS_LICENSE
  fileId          String
  file            File            @relation(fields: [fileId], references: [id])

  verifiedAt      DateTime?

  createdAt       DateTime        @default(now())

  @@index([kycId])
}

// =============================================================================
// PRODUCTS & CATALOG
// =============================================================================

model Product {
  id              String          @id @default(cuid())
  sku             String          @unique
  name            String
  slug            String          @unique

  // Description (compliance-checked)
  shortDescription String?
  longDescription  String?

  category        ProductCategory

  // Research details
  purityPercent   Float?          // e.g., 99.5
  molecularWeight Float?
  sequence        String?         // Amino acid sequence
  casNumber       String?         // CAS Registry Number

  // Pricing
  basePrice       Decimal         @db.Decimal(10, 2)
  compareAtPrice  Decimal?        @db.Decimal(10, 2)

  // Shipping
  weightGrams     Int?            // Weight in grams for shipping calculations
  lengthMm        Int?            // Dimensions for box size calculations
  widthMm         Int?
  heightMm        Int?

  // Inventory
  trackInventory  Boolean         @default(true)

  // Status
  isActive        Boolean         @default(true)
  isFeatured      Boolean         @default(false)

  // Catalog flags
  costPerUnit     Decimal?        @db.Decimal(10, 2)  // Internal CPU â€” admin-only, never public
  wholesaleOnly   Boolean         @default(false)      // Hidden from public shop (gray rows)
  comingSoon      Boolean         @default(false)      // Shown with badge, cart disabled (blue rows)
  subcategory     String?                              // Shop section ID: "metabolic", "cosmetic", etc.

  // SEO
  metaTitle       String?
  metaDescription String?

  variants        ProductVariant[]
  batches         ProductBatch[]
  images          ProductImage[]
  inventory       Inventory?
  orderItems      OrderItem[]
  priceListItems  PriceListItem[]
  stockNotifications StockNotification[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([sku])
  @@index([slug])
  @@index([category])
  @@index([isActive])
  @@index([wholesaleOnly])
  @@index([subcategory])
}

model ProductVariant {
  id              String    @id @default(cuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku             String    @unique
  name            String    // e.g., "10mg", "5mg"

  price           Decimal   @db.Decimal(10, 2)
  compareAtPrice  Decimal?  @db.Decimal(10, 2)

  // Variant-specific details
  strength        String?   // "10mg", "20mg"
  quantity        Int?      // Number of vials/units

  // Shipping (overrides product weight if set)
  weightGrams     Int?      // Weight in grams

  // Catalog flags
  costPerUnit     Decimal?  @db.Decimal(10, 2)  // Variant-level CPU
  wholesaleOnly   Boolean   @default(false)      // Per-variant wholesale flag

  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)

  inventory       Inventory?
  orderItems      OrderItem[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([productId])
  @@index([sku])
}

model ProductImage {
  id              String    @id @default(cuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  url             String
  altText         String?
  sortOrder       Int       @default(0)
  isPrimary       Boolean   @default(false)

  createdAt       DateTime  @default(now())

  @@index([productId])
}

model ProductBatch {
  id              String    @id @default(cuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  batchNumber     String    @unique

  manufacturingDate DateTime
  expirationDate   DateTime

  purityPercent   Float     // HPLC verified purity

  // COA & Documentation
  coaFileId       String?
  coaFile         File?     @relation("BatchCOA", fields: [coaFileId], references: [id])
  msdsFileId      String?
  msdsFile        File?     @relation("BatchMSDS", fields: [msdsFileId], references: [id])

  // Inventory
  initialQuantity Int
  currentQuantity Int

  isActive        Boolean   @default(true)

  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([productId])
  @@index([batchNumber])
  @@index([isActive])
}

// =============================================================================
// INVENTORY
// =============================================================================

model Inventory {
  id              String          @id @default(cuid())

  productId       String?         @unique
  product         Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)

  variantId       String?         @unique
  variant         ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  quantity        Int             @default(0)
  reservedQuantity Int            @default(0)
  lowStockThreshold Int           @default(10)

  lastRestockedAt DateTime?
  leadTimeDays    Int?            // Days to restock if orderable but not on-hand

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model StockNotification {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  email           String
  notified        Boolean   @default(false)
  notifiedAt      DateTime?

  createdAt       DateTime  @default(now())

  @@unique([userId, productId])
  @@index([productId])
}

// =============================================================================
// ORDERS
// =============================================================================

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  userId          String
  user            User          @relation(fields: [userId], references: [id])

  status          OrderStatus   @default(PENDING)

  // Addresses
  shippingAddressId String
  shippingAddress   Address     @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddressId  String
  billingAddress    Address     @relation("BillingAddress", fields: [billingAddressId], references: [id])

  // Totals
  subtotal        Decimal       @db.Decimal(10, 2)
  shippingCost    Decimal       @db.Decimal(10, 2) @default(0)
  taxAmount       Decimal       @db.Decimal(10, 2) @default(0)
  discountAmount  Decimal       @db.Decimal(10, 2) @default(0)
  totalAmount     Decimal       @db.Decimal(10, 2)

  // Discount/Promo
  discountCode    String?

  // Affiliate tracking
  affiliateReferralCode String?

  // Notes
  customerNotes   String?
  adminNotes      String?

  // Processing
  processingType  String        @default("STANDARD") // STANDARD, RUSH, EXPRESS

  items           OrderItem[]
  payments        Payment[]
  shipment        Shipment?
  complianceAck   ComplianceAcknowledgment?
  loyaltyTransactions LoyaltyTransaction[]
  paymentLinks    PaymentLink[]

  paymentStatus   String        @default("PENDING") // PENDING, AWAITING_PAYMENT, PAID, FAILED
  paidAt          DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id              String          @id @default(cuid())
  orderId         String
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId       String
  product         Product         @relation(fields: [productId], references: [id])
  variantId       String?
  variant         ProductVariant? @relation(fields: [variantId], references: [id])

  // Snapshot at time of order
  productName     String
  variantName     String?
  sku             String

  quantity        Int
  unitPrice       Decimal         @db.Decimal(10, 2)
  totalPrice      Decimal         @db.Decimal(10, 2)

  // Batch tracking
  batchNumber     String?

  createdAt       DateTime        @default(now())

  @@index([orderId])
  @@index([productId])
}

// =============================================================================
// PAYMENTS
// =============================================================================

model Payment {
  id              String        @id @default(cuid())
  orderId         String
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  method          PaymentMethod
  status          PaymentStatus @default(PENDING)

  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")

  // Epicor Propello
  propelloTransactionId String?
  propelloPaymentIntentId String?

  // Manual payments
  referenceNumber String?       // Zelle/Venmo/Wire reference
  proofFileId     String?
  proofFile       File?         @relation(fields: [proofFileId], references: [id])

  // Verification
  verifiedBy      String?
  verifiedAt      DateTime?
  verificationNotes String?

  // Refund
  refundedAmount  Decimal?      @db.Decimal(10, 2)
  refundedAt      DateTime?
  refundReason    String?

  metadata        Json?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([orderId])
  @@index([status])
}

model PaymentLink {
  id              String    @id @default(cuid())

  orderId         String?
  order           Order?    @relation(fields: [orderId], references: [id])

  customerEmail   String
  customerName    String?
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")

  status          String    @default("PENDING") // PENDING, PAID, EXPIRED, CANCELLED
  paymentMethods  Json      @default("[]") // ["Zelle", "Venmo", "Wire", "Crypto"]
  paymentMethod   String?   // Method used when paid

  notes           String?
  proofUrl        String?

  token           String    @unique
  expiresAt       DateTime

  paidAt          DateTime?

  createdById     String?
  createdBy       User?     @relation("PaymentLinksCreated", fields: [createdById], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([token])
  @@index([status])
  @@index([customerEmail])
}

// =============================================================================
// SHIPPING
// =============================================================================

model Shipment {
  id              String        @id @default(cuid())
  orderId         String        @unique
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  status          ShipmentStatus @default(PENDING)

  // Carrier info
  carrier         String?       // "USPS", "FEDEX", "UPS"
  serviceLevel    String?       // "Priority Mail", "Ground", etc.

  // Shipping provider IDs (EasyPost)
  externalShipmentId    String?  @map("shippoShipmentId")
  externalRateId        String?  @map("shippoRateId")
  externalTransactionId String?  @map("shippoTransactionId")

  // Tracking
  trackingNumber  String?
  trackingUrl     String?

  // Label
  labelUrl        String?
  labelFileId     String?

  // Costs
  shippingCost    Decimal       @db.Decimal(10, 2)
  insuranceAmount Decimal?      @db.Decimal(10, 2)

  // Dates
  estimatedDelivery DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // Package details
  weightLbs       Decimal?      @db.Decimal(5, 2)
  lengthIn        Decimal?      @db.Decimal(5, 2)
  widthIn         Decimal?      @db.Decimal(5, 2)
  heightIn        Decimal?      @db.Decimal(5, 2)

  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([trackingNumber])
}

// =============================================================================
// COMPLIANCE
// =============================================================================

model ComplianceAcknowledgment {
  id              String    @id @default(cuid())
  orderId         String    @unique
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId          String
  user            User      @relation(fields: [userId], references: [id])

  // Required checkboxes
  researchPurposeOnly    Boolean
  ageConfirmation        Boolean
  noHumanConsumption     Boolean
  responsibilityAccepted Boolean
  termsAccepted          Boolean

  // Audit trail
  ipAddress       String
  userAgent       String?

  // Version tracking
  checkboxVersion String    @default("1.0.0")

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([createdAt])
}

model ForbiddenTerm {
  id              String    @id @default(cuid())
  term            String    @unique
  category        String?   // "medical", "supplement", "claim"
  severity        String    @default("BLOCK") // BLOCK, WARN

  createdAt       DateTime  @default(now())

  @@index([term])
}

// =============================================================================
// PRICING (Wholesale/B2B)
// =============================================================================

model PriceList {
  id              String          @id @default(cuid())
  name            String
  description     String?

  discountPercent Float?          // Global discount

  organization    Organization?   @relation(fields: [organizationId], references: [id])
  organizationId  String?         @unique

  isActive        Boolean         @default(true)

  items           PriceListItem[]
  users           User[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model PriceListItem {
  id              String    @id @default(cuid())
  priceListId     String
  priceList       PriceList @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  customPrice     Decimal?  @db.Decimal(10, 2)
  discountPercent Float?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([priceListId, productId])
}

model PriceTier {
  id              String    @id @default(cuid())
  name            String
  minQuantity     Int
  discountPercent Float

  createdAt       DateTime  @default(now())
}

// =============================================================================
// FILES
// =============================================================================

model File {
  id              String        @id @default(cuid())

  filename        String
  originalName    String
  mimeType        String
  size            Int

  type            FileType

  // Storage
  bucket          String
  key             String        // S3/R2 key

  // Access
  isPublic        Boolean       @default(false)

  uploadedBy      String?

  // Relations
  kycDocuments    KycDocument[]
  payments        Payment[]
  batchCoas       ProductBatch[] @relation("BatchCOA")
  batchMsds       ProductBatch[] @relation("BatchMSDS")

  createdAt       DateTime      @default(now())

  @@index([type])
  @@index([bucket, key])
}

// =============================================================================
// CONTENT
// =============================================================================

model Blog {
  id              String    @id @default(cuid())
  slug            String    @unique
  title           String
  excerpt         String?
  content         String

  featuredImage   String?

  authorId        String?

  isPublished     Boolean   @default(false)
  publishedAt     DateTime?

  metaTitle       String?
  metaDescription String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@index([isPublished])
}

model Faq {
  id              String    @id @default(cuid())
  question        String
  answer          String
  category        String?
  sortOrder       Int       @default(0)

  isPublished     Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([category])
}

// =============================================================================
// SETTINGS
// =============================================================================

model Setting {
  id              String    @id @default(cuid())
  key             String    @unique
  value           String
  type            String    @default("string") // string, number, boolean, json
  description     String?

  updatedAt       DateTime  @updatedAt

  @@index([key])
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model AuditLog {
  id              String      @id @default(cuid())

  userId          String?
  user            User?       @relation("UserAuditLogs", fields: [userId], references: [id])
  adminId         String?
  admin           User?       @relation("AdminAuditLogs", fields: [adminId], references: [id])

  action          AuditAction
  resourceType    String      // "Order", "Product", "User", etc.
  resourceId      String?

  previousState   Json?
  newState        Json?

  ipAddress       String?
  userAgent       String?

  metadata        Json?

  createdAt       DateTime    @default(now())

  @@index([userId])
  @@index([adminId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
}

// =============================================================================
// LOYALTY
// =============================================================================

model LoyaltyTransaction {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  orderId         String?
  order           Order?            @relation(fields: [orderId], references: [id])

  type            LoyaltyPointType
  points          Int               // Positive for earned/bonus, negative for redeemed/expired
  description     String?

  createdAt       DateTime          @default(now())

  @@index([userId])
  @@index([orderId])
  @@index([type])
  @@index([createdAt])
}

// =============================================================================
// DISCOUNTS & COUPONS
// =============================================================================

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum DiscountStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

model Discount {
  id              String          @id @default(cuid())
  code            String          @unique
  description     String?

  type            DiscountType
  value           Decimal         @db.Decimal(10, 2) // Percentage (0-100) or fixed amount

  // Restrictions
  minOrderAmount  Decimal?        @db.Decimal(10, 2)
  maxDiscountAmount Decimal?      @db.Decimal(10, 2) // Cap for percentage discounts
  usageLimit      Int?            // Total uses allowed
  usageCount      Int             @default(0)
  perUserLimit    Int?            // Uses per customer

  // Validity
  status          DiscountStatus  @default(ACTIVE)
  startsAt        DateTime        @default(now())
  expiresAt       DateTime?

  // Targeting (optional)
  productIds      String[]        // Empty = all products
  categoryIds     String[]        // Empty = all categories
  userIds         String[]        // Empty = all users

  // Audit
  createdById     String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([code])
  @@index([status])
  @@index([expiresAt])
}

// =============================================================================
// RETURNS & REFUNDS
// =============================================================================

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  RECEIVED
  REFUNDED
  COMPLETED
}

enum ReturnReason {
  DAMAGED
  WRONG_ITEM
  NOT_AS_DESCRIBED
  CHANGED_MIND
  DEFECTIVE
  OTHER
}

model Return {
  id              String        @id @default(cuid())
  orderId         String
  orderNumber     String        // Denormalized for easy lookup

  userId          String
  customerEmail   String
  customerName    String?

  status          ReturnStatus  @default(REQUESTED)
  reason          ReturnReason
  reasonDetails   String?

  // Items being returned
  items           Json          // [{orderItemId, productName, quantity, unitPrice}]

  // Amounts
  subtotalAmount  Decimal       @db.Decimal(10, 2)
  refundAmount    Decimal?      @db.Decimal(10, 2)

  // Admin handling
  processedById   String?
  processedAt     DateTime?
  adminNotes      String?
  rejectionReason String?

  // Refund details
  refundMethod    String?       // Original payment method or store credit
  refundReference String?       // Transaction ID

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// =============================================================================
// AFFILIATE PROGRAM
// =============================================================================

model AffiliateApplication {
  id                String            @id @default(cuid())
  fullName          String
  email             String
  phone             String?
  primaryPlatform   String            // instagram, tiktok, youtube, blog, etc.
  socialLinks       Json              // { instagram: "...", tiktok: "...", youtube: "...", website: "..." }
  audienceSize      String?           // "1k-10k", "10k-50k", "50k-100k", "100k+"
  contentFocus      String?           // fitness, wellness, biohacking, etc.
  whyPartner        String?           // free-text motivation
  resumePath        String?           // local file path for uploaded resume
  status            ApplicationStatus @default(PENDING)
  reviewedById      String?
  reviewedAt        DateTime?
  rejectionReason   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model Affiliate {
  id                String            @id @default(cuid())
  userId            String            @unique
  user              User              @relation(fields: [userId], references: [id])
  referralCode      String            @unique
  commissionRate    Decimal           @default(0.05) @db.Decimal(5, 4) // 5%
  isActive          Boolean           @default(true)

  // Stats (denormalized for dashboard performance)
  totalClicks       Int               @default(0)
  totalOrders       Int               @default(0)
  totalRevenue      Decimal           @default(0) @db.Decimal(12, 2)
  totalCommission   Decimal           @default(0) @db.Decimal(12, 2)
  pendingPayout     Decimal           @default(0) @db.Decimal(12, 2)

  referrals         AffiliateReferral[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([referralCode])
  @@index([isActive])
}

model AffiliateReferral {
  id                String            @id @default(cuid())
  affiliateId       String
  affiliate         Affiliate         @relation(fields: [affiliateId], references: [id])
  orderId           String?
  clickedAt         DateTime          @default(now())
  convertedAt       DateTime?
  orderAmount       Decimal?          @db.Decimal(10, 2)
  commissionAmount  Decimal?          @db.Decimal(10, 2)
  paidOut           Boolean           @default(false)
  paidOutAt         DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([affiliateId])
  @@index([orderId])
  @@index([paidOut])
}

// =============================================================================
// BRAND PARTNER PROGRAM
// =============================================================================

model BrandPartnerApplication {
  id                  String            @id @default(cuid())
  organizationName    String
  contactName         String
  email               String
  phone               String?
  orgType             String            // retailer, clinic, distributor, gym, other
  website             String?
  location            String?           // city/state
  partnershipFocus    String?           // wholesale, white-label, co-branding, research
  partnershipOverview String?           // free-text description of partnership goals
  documentPaths       Json?             // array of uploaded document file paths
  status              ApplicationStatus @default(PENDING)
  reviewedById        String?
  reviewedAt          DateTime?
  rejectionReason     String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// =============================================================================
// NEWSLETTER SUBSCRIBERS
// =============================================================================

model NewsletterSubscriber {
  id            String    @id @default(cuid())
  email         String    @unique
  source        String?   // promo_popup, footer, checkout, manual
  isActive      Boolean   @default(true)
  subscribedAt  DateTime  @default(now())
  unsubscribedAt DateTime?
  ipAddress     String?

  @@index([email])
  @@index([isActive])
  @@index([subscribedAt])
}

// =============================================================================
// MARKETING POPUPS (Admin-controlled)
// =============================================================================

model MarketingPopup {
  id              String    @id @default(cuid())
  name            String                          // internal name for admin reference
  isActive        Boolean   @default(false)       // toggle on/off from admin
  headline        String                          // e.g. "Welcome to SBB"
  subtitle        String?                         // supporting text
  bodyHtml        String?                         // optional rich content
  ctaText         String    @default("Unlock")    // button label
  ctaLink         String?                         // optional redirect after submit
  discountCode    String?                         // shown after email capture
  discountCode2   String?                         // second tier code (optional)
  tier1Label      String?                         // e.g. "10% off orders under $500"
  tier1Value      String?                         // e.g. "10%"
  tier2Label      String?                         // e.g. "15% off orders $500+"
  tier2Value      String?                         // e.g. "15%"
  showEmailCapture Boolean  @default(true)        // show email form or just message
  successHeadline String?                         // e.g. "You're In!"
  successMessage  String?                         // shown after submit
  delayMs         Int       @default(3500)        // delay before showing (ms)
  showOnPages     String[]                        // empty = all pages, or ["index.html","shop.html"]
  showFrequency   String    @default("once")      // once, every_visit, every_session
  startsAt        DateTime?                       // schedule start (null = immediate)
  expiresAt       DateTime?                       // schedule end (null = indefinite)
  priority        Int       @default(0)           // higher = shown first if multiple active
  impressions     Int       @default(0)           // times shown
  conversions     Int       @default(0)           // emails captured
  createdById     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([isActive])
  @@index([priority])
}
